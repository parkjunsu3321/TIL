# ML FLOW

## ğŸ¤” ML Flowë€?

> **MLflowëŠ” ë¨¸ì‹ ëŸ¬ë‹(ML) ì‹¤í—˜ì„ ê´€ë¦¬í•˜ê³ , ëª¨ë¸ì„ ì¶”ì Â·ë°°í¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼**
> 
> 
> ì…ë‹ˆë‹¤. ë¨¸ì‹ ëŸ¬ë‹ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ "ì‹¤í—˜ ê´€ë¦¬ + ëª¨ë¸ ì €ì¥ + ë°°í¬"ë¥¼ í•œ ë²ˆì— ì§€ì›í•˜ëŠ” ë„êµ¬ë¼ê³  ë³´ë©´ ë©ë‹ˆë‹¤.
> 
![title](https://private-user-images.githubusercontent.com/127470862/497431413-55bc28bf-f2a0-4cc0-b84e-3de7d4d2780d.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NTk1NzQxMjEsIm5iZiI6MTc1OTU3MzgyMSwicGF0aCI6Ii8xMjc0NzA4NjIvNDk3NDMxNDEzLTU1YmMyOGJmLWYyYTAtNGNjMC1iODRlLTNkZTdkNGQyNzgwZC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUxMDA0JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MTAwNFQxMDMwMjFaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT1kMGU3MWJjMjAxMTQ1YmI1MjMxYzQ3MDlkOTA1YzM0ZTQ1MmRkM2U5ODNjYmU1YTVkMzc0ZmU3YWU5ZTU4MmU5JlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.tDMP_vrJsWNXrq7Zo6zZ5mMSW_hAW8FHSPHKclVWGU0)   



MLflowì˜ ì›Œí¬í”Œë¡œìš°ëŠ” ìœ„ ê·¸ë¦¼ê³¼ ê°™ìŠµë‹ˆë‹¤.

ë¨¼ì € Tracking Serverì—ì„œ ì‹œì‘ë˜ë©°, ì—¬ê¸°ì„œ ì‹¤í—˜ì˜ Parameters, Metrics, Artifacts, Metadata, ê·¸ë¦¬ê³  Modelsë¥¼ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ ì¶”ì ëœ ëª¨ë¸ê³¼ ê´€ë ¨ ì •ë³´ëŠ” Model Registryë¡œ ì „ë‹¬ë˜ë©°, Model RegistryëŠ” ê°œë°œìë“¤ë¼ë¦¬ í˜‘ì—…í•  ìˆ˜ ìˆëŠ” ì¤‘ì•™ ì €ì¥ì†Œ ì—­í• ì„ í•©ë‹ˆë‹¤. ëª¨ë¸ì€ Staging ë‹¨ê³„ì—ì„œ ê²€ì¦ì„ ê±°ì¹œ í›„, Production ë‹¨ê³„ë¡œ ìŠ¹ê²©ë˜ì–´ ì‹¤ì œ ì„œë¹„ìŠ¤ì— í™œìš©ë˜ë©° í•„ìš” ì‹œ Archived ìƒíƒœë¡œ ë³´ê´€ë©ë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ Reviewerì™€ CI/CD Toolsê°€ ê°œì…í•˜ì—¬ í’ˆì§ˆ ë³´ì¦ê³¼ ìë™í™”ëœ ë°°í¬ íŒŒì´í”„ë¼ì¸ì„ ì§€ì›í•©ë‹ˆë‹¤. ìµœì¢…ì ìœ¼ë¡œ Production ë‹¨ê³„ì˜ ëª¨ë¸ì€ Downstream ì• í”Œë¦¬ì¼€ì´ì…˜, Automated Jobs, REST Servingì„ í†µí•´ ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ í™œìš©ë˜ë©°, ì•ˆì •ì ì´ê³  ì¼ê´€ëœ ëª¨ë¸ ë°°í¬ê°€ ê°€ëŠ¥í•´ì§„ë‹¤.

## ğŸ”Š ML Flowê°€ ìˆì–´ì•¼í•˜ëŠ” ì´ìœ 

### 1ï¸âƒ£ ë¨¸ì‹ ëŸ¬ë‹ ì‹¤í—˜ì€ **ì¬í˜„(reproducibility)** ì´ ì–´ë ¤ì›€

- ë¬¸ì œ: ê°™ì€ ì½”ë“œë¼ë„ í™˜ê²½/ë²„ì „ì´ ì¡°ê¸ˆë§Œ ë‹¬ë¼ì§€ë©´ ê²°ê³¼ê°€ ë‹¬ë¼ì§
- MLflow ì—­í• :
    - ì½”ë“œ, ë°ì´í„° ê²½ë¡œ, íŒŒë¼ë¯¸í„°, ë©”íŠ¸ë¦­ì„ ìë™ìœ¼ë¡œ ê¸°ë¡
    - ë™ì¼í•œ ì‹¤í—˜ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ê±°ë‚˜, ë‹¤ë¥¸ ì‚¬ëŒë„ ë˜‘ê°™ì´ ì¬í˜„ ê°€ëŠ¥

### 2ï¸âƒ£ **ì‹¤í—˜ ì¶”ì ê³¼ ë¹„êµ**ê°€ í˜ë“¦

- ë¬¸ì œ: â€œlearning_rate=0.01ì¼ ë•Œ ì •í™•ë„ê°€ ëª‡ %ì˜€ë”ë¼?â€ ë§¤ë²ˆ ê¸°ì–µí•˜ê±°ë‚˜ ì—‘ì…€ë¡œ ê´€ë¦¬í•´ì•¼ í•¨
- MLflow ì—­í• :
    - ëª¨ë“  ì‹¤í—˜ì„ UI ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥
    - íŒŒë¼ë¯¸í„°, ë©”íŠ¸ë¦­, ê·¸ë˜í”„ë¥¼ ì†ì‰½ê²Œ ë¹„êµ â†’ **ìµœì  ëª¨ë¸ ì„ íƒ** ê°€ëŠ¥

### 3ï¸âƒ£ **ëª¨ë¸ ë²„ì „ ê´€ë¦¬** í•„ìš”

- ë¬¸ì œ: ëª¨ë¸ì´ ê³„ì† ì—…ë°ì´íŠ¸ë˜ëŠ”ë°, **ì–´ëŠ ë²„ì „ì´ í˜„ì¬ ì„œë¹„ìŠ¤ ì¤‘ì¸ì§€** ê´€ë¦¬ê°€ ì–´ë ¤ì›€
- MLflow ì—­í• :
    - Model Registryë¥¼ í†µí•´ **Staging â†’ Production â†’ Archived** ë‹¨ê³„ ê´€ë¦¬
    - ëª¨ë¸ì— ë²„ì „ íƒœê¹…(ì˜ˆ: v1, v2) ê°€ëŠ¥

### 4ï¸âƒ£ **ë°°í¬(Serving)** ìë™í™”ê°€ í•„ìš”

- ë¬¸ì œ: ëª¨ë¸ì„ ì €ì¥í–ˆì§€ë§Œ ìš´ì˜ í™˜ê²½(API, ë°°ì¹˜ ì‘ì—…)ì— ì˜¬ë¦¬ëŠ” ê²Œ ë²ˆê±°ë¡­ê³  ì‹¤ìˆ˜ ì¦ìŒ
- MLflow ì—­í• :
    - REST API Serving ì§€ì›
    - CI/CD íŒŒì´í”„ë¼ì¸ê³¼ ì‰½ê²Œ ì—°ê²° â†’ **ëª¨ë¸ì„ ë°”ë¡œ ì„œë¹„ìŠ¤ì— ì ìš© ê°€ëŠ¥**

### 5ï¸âƒ£ **íŒ€ í˜‘ì—…**ì—ì„œ í•„ìˆ˜

- ë¬¸ì œ: ì—°êµ¬ìì™€ ì—”ì§€ë‹ˆì–´ê°€ ë‹¤ë¥¸ íˆ´ì„ ì“°ë©´, ëª¨ë¸/ì½”ë“œ ê³µìœ ê°€ ë²ˆê±°ë¡­ê³  ë¶ˆì¼ì¹˜ ë°œìƒ
- MLflow ì—­í• :
    - Data ScientistëŠ” Trackingì— ê¸°ë¡
    - Deployment EngineerëŠ” Registryì—ì„œ ëª¨ë¸ ê°€ì ¸ì™€ ë°°í¬
    - ê°™ì€ í”Œë«í¼ì—ì„œ í˜‘ì—… ê°€ëŠ¥

## âŒ¨ï¸ ML Flow ê¸°ëŠ¥

### 1ï¸âƒ£ **Tracking Server (ì™¼ìª½ ë°•ìŠ¤)**

- ML ì‹¤í—˜ ê²°ê³¼ë¥¼ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ëŠ” ê³µê°„
- ì£¼ìš” ê¸°ëŠ¥:
    - **Parameters**: í•™ìŠµì— ì‚¬ìš©í•œ í•˜ì´í¼íŒŒë¼ë¯¸í„° (ì˜ˆ: learning_rate, batch_size)
    - **Metrics**: ì„±ëŠ¥ ì§€í‘œ (ì˜ˆ: accuracy, loss, RMSE)
    - **Artifacts**: í•™ìŠµ ê³¼ì •ì—ì„œ ìƒì„±ëœ ì‚°ì¶œë¬¼ (ì˜ˆ: ëª¨ë¸ ê°€ì¤‘ì¹˜ íŒŒì¼, ì‹œê°í™” ê·¸ë˜í”„)
    - **Metadata & Models**: ëª¨ë¸ ìì²´ ë° ë¶€ê°€ ì •ë³´

â¡ï¸ ì¦‰, ê°œë°œìê°€ ì‹¤í—˜ì„ í•  ë•Œ ë‚¨ê¸°ëŠ” â€œì—°êµ¬ ë…¸íŠ¸ + ë¡œê·¸ ì €ì¥ì†Œâ€ ì—­í• ì„ í•©ë‹ˆë‹¤.

### 2ï¸âƒ£ **Model Registry (ê°€ìš´ë° ë°•ìŠ¤)**

- Tracking Serverì—ì„œ ê¸°ë¡ëœ ëª¨ë¸ì„ **ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì €ì¥ì†Œ**
- ëª¨ë¸ì˜ **ë²„ì „ ê´€ë¦¬ + ìƒíƒœ ê´€ë¦¬**ê°€ í•µì‹¬
- ìƒíƒœ ë‹¨ê³„:
    - **Staging**: í…ŒìŠ¤íŠ¸ ë‹¨ê³„ (ì•„ì§ ìš´ì˜ì— ë°˜ì˜í•˜ì§€ ì•ŠìŒ)
    - **Production**: ìš´ì˜ í™˜ê²½ì—ì„œ ì‹¤ì œ ì‚¬ìš©ë˜ëŠ” ëª¨ë¸
    - **Archived**: ë” ì´ìƒ ì“°ì§€ ì•ŠëŠ” ëª¨ë¸, ë³´ê´€ìš©

â¡ï¸ ì—¬ê¸°ì„œ **Data Scientists**ëŠ” ëª¨ë¸ì„ ì˜¬ë¦¬ê³ , **Deployment Engineers**ëŠ” ìš´ì˜ í™˜ê²½ìœ¼ë¡œ ë°°í¬/ê´€ë¦¬í•©ë‹ˆë‹¤.

### 3ï¸âƒ£ **Downstream í™œìš© (ì˜¤ë¥¸ìª½ ë°•ìŠ¤)**

ë“±ë¡ëœ ëª¨ë¸ì€ ì—¬ëŸ¬ ë°©ì‹ìœ¼ë¡œ í™œìš©ë  ìˆ˜ ìˆì–´ìš”:

- **Downstream**: ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ëª¨ë¸ì„ ë¶ˆëŸ¬ë‹¤ ì“°ëŠ” ê²½ìš°
- **Automated Jobs**: ìŠ¤ì¼€ì¤„ë§ëœ ìë™ ì‘ì—… (ì˜ˆ: ë§¤ì¼ ìƒˆ ë°ì´í„°ë¡œ ì˜ˆì¸¡ ì‹¤í–‰)
- **REST Serving**: API í˜•íƒœë¡œ ë°°í¬í•˜ì—¬, ì™¸ë¶€ì—ì„œ HTTP ìš”ì²­ì„ ë³´ë‚´ ëª¨ë¸ ì˜ˆì¸¡ì„ ë°›ìŒ

â¡ï¸ ì¦‰, **ëª¨ë¸ì„ ì‹¤ì œ ì„œë¹„ìŠ¤ì— ì—°ê²°**í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

### 4ï¸âƒ£ **CI/CD + Reviewer (ì•„ë˜ ë°•ìŠ¤)**

- ëª¨ë¸ì´ **Staging â†’ Production**ìœ¼ë¡œ ë„˜ì–´ê°€ê¸° ì „ì— ë¦¬ë·° ë° ìŠ¹ì¸ ì ˆì°¨ë¥¼ ê±°ì¹  ìˆ˜ ìˆìŒ
- CI/CD íˆ´(Jenkins, GitHub Actions, GitLab CI ë“±)ê³¼ ì—°ë™ ê°€ëŠ¥
- ëª¨ë¸ ë°°í¬ë„ **ìë™í™” íŒŒì´í”„ë¼ì¸**ì— í†µí•©í•  ìˆ˜ ìˆìŒ

## ğŸ‹ï¸ ML Flow ì‚¬ìš© ì˜ˆì‹œ

### ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°

```python
import mlflow
import mlflow.sklearn
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.model_selection import train_test_split
from sklearn.datasets import load_diabetes
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error, r2_score
```

### ë°ì´í„° ë¡œë“œ ë° ë¶„í• 

```python
data = load_diabetes()
X_train, X_test, y_train, y_test = train_test_split(
data.data, data.target, test_size=0.2, random_state=42
)
```

### MLflow ì‹¤í—˜ ì´ë¦„ ì„¤ì •

```python
mlflow.set_experiment("RandomForest Experiment")
```

### í•˜ì´í¼íŒŒë¼ë¯¸í„° íƒìƒ‰ ì„¤ì •

```python
n_estimators_list = [10, 50, 100, 200]
max_depth_list = [3, 5, 10, None]
```

### ë°˜ë³µ í•™ìŠµ ë° í‰ê°€

```python
for n_estimators in n_estimators_list:
for max_depth in max_depth_list:
with mlflow.start_run():
# ëª¨ë¸ í•™ìŠµ
model = RandomForestRegressor(
n_estimators=n_estimators, max_depth=max_depth, random_state=42
)
model.fit(X_train, y_train)
```

### ì˜ˆì¸¡ ë° ì„±ëŠ¥ í‰ê°€

```python
y_pred = model.predict(X_test)
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)
```

### MLflow ë¡œê·¸ ê¸°ë¡

```python
mlflow.log_param("n_estimators", n_estimators)
mlflow.log_param("max_depth", max_depth)
mlflow.log_metric("mse", mse)
mlflow.log_metric("r2_score", r2)
mlflow.sklearn.log_model(model, "random_forest_model")
```

### ì‹œê°í™” ë° ì•„í‹°íŒ©íŠ¸ ì €ì¥

```python
plt.figure(figsize=(6, 4))
plt.scatter(y_test, y_pred, alpha=0.6, color="blue")
plt.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()], '--r', linewidth=2)
plt.xlabel("Actual")
plt.ylabel("Predicted")
plt.title(f"Prediction Scatter Plot (n={n_estimators}, depth={max_depth})")
plt.savefig("scatter_plot.png")
plt.close()
mlflow.log_artifact("scatter_plot.png")
```

### ë¡œê·¸ ì¶œë ¥

```python
print(f"Logged: n_estimators={n_estimators}, max_depth={max_depth}, MSE={mse:.4f}, R2={r2:.4f}")
```

### ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë“±ë¡

```python
import mlflow
import mlflow.sklearn
from mlflow import MlflowClient
from sklearn.metrics import mean_squared_error
import numpy as np

mlflow.sklearn.log_model(
    sk_model=model,
    artifact_path="random_forest_model",
    registered_model_name="RandomForestRegressor"
)

client = MlflowClient()
experiment = client.get_experiment_by_name("RandomForest test")
experiment_id = experiment.experiment_id

runs = client.search_runs(
    experiment_ids=[experiment_id],
    order_by=["metrics.rmse ASC"],
    max_results=1
)

best_run = runs[0]
best_run_id = best_run.info.run_id
print("Best run_id:", best_run_id)
print("Best RMSE:", best_run.data.metrics["mse"])

model_name = "RandomForestRegressor"
model_uri = f"runs:/{best_run_id}/random_forest_model"

mv = mlflow.register_model(model_uri=model_uri, name=model_name)
print(f"Registered model version: {mv.version}")

client.set_registered_model_alias(model_name, "champion", mv.version)
print(f"âœ… Champion model updated to version {mv.version}")
```

### MLflow ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ê¸°

**Best RUN**

```python
from mlflow.tracking import MlflowClient

client = MlflowClient()
experiment = client.get_experiment_by_name("RandomForest test")
runs = client.search_runs(experiment.experiment_id, order_by=["metrics.r2_score DESC"], max_results=1)

best_run = runs[0]
print("Best Run ID:", best_run.info.run_id)
print("Best Params:", best_run.data.params)
print("Best Metrics:", best_run.data.metrics)
```

**ëª¨ë¸ ë¡œë“œ ë° ì¬ì‚¬ìš©**

```python
from mlflow.tracking import MlflowClient

client = MlflowClient()
experiment = client.get_experiment_by_name("RandomForest test")
runs = client.search_runs(experiment.experiment_id, order_by=["metrics.r2_score DESC"], max_results=1)

best_run = runs[0]
print("Best Run ID:", best_run.info.run_id)
print("Best Params:", best_run.data.params)
print("Best Metrics:", best_run.data.metrics)
```